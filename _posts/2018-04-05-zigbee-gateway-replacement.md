---
layout: post
title: "Данные летят в Китай? Только ты не допускай!"
date:   2018-04-05
description: "Данные летят в Китай? Только ты не допускай!"
categories: Hardware
main-class: 'hardware'
tags: hardware zigbee cc2531
excerpt:
introduction: "Сегодня я поддержу этих пользователей и расскажу как можно отобрать у компании Xiaomi контроль за их датчиками и кнопками, работающими по протоколу Zigbee. Эти датчики и устройства очень популярны среди любителей 'этого дела' (домашней автоматизации и 'Умных домов') благодаря своей доступности и внешнему виду."
---

[Source](https://www.indahomekit.ru/2018/04/05/danne-letyat-v-kitay-tolyko-t-ne-dopuskay/ "Permalink to Данные летят в Китай? Только ты не допускай!")

# Данные летят в Китай? Только ты не допускай!

Большинство "умных" устройств всячески стараются затащить вас в свою постель экосистему и держать там как можно дольше. Всякие "умные" лампочки, розетки, камеры предлагают вам зарегистрировать устройство на собственном сервере, чтобы через приложение удобно им управлять.

"_Шибко умные!_", — считают продвинутые пользователи, которым не сидится на месте ровно, и всячески пытаются перехватить управление этими устройствами в свои руки. Это отчасти связано с паранойей — "за нами следят". Им кажется, что "товарищ майор", либо "хитрый китаец" знают что происходит у них дома, следят за ними через камеру и в любой удобный момент могут отключить свет в туалете, пока они там находятся.

Поэтому, эти пользователи создают "хаки", прошивки и другие обходные маневры, чтобы остановить слежку и перенаправить "умные" устройства на свой собственный сервер.

Сегодня я поддержу этих пользователей и расскажу как можно отобрать у компании Xiaomi контроль за их датчиками и кнопками, работающими по протоколу Zigbee. Эти датчики и устройства очень популярны среди любителей "этого дела" (домашней автоматизации и "Умных домов") благодаря своей доступности и внешнему виду.

Пусть в Китай летят [журавли][1], а наши данные останутся при нас.

## Узкие места

Стратегически важным "местом утечки данных" считается Zigbee-Wifi-шлюз от Xiaomi, который подключен к сети и может отправлять какие-то данные на внешние сервера. Но это легко исправляется, если на роутере заблокировать внешний доступ этому устройству.

Еще одним "узким местом" является аккаунт в приложении MiHome, где настроено подключение к шлюзу и видны все устройства заведенные в него. Для этого случая уже давно известен способ включения developer-режима на шлюзе и получения управляющего токена. После чего, можно напрямую общаться со шлюзом по сети без приложения MiHome. Именно этим способом пользуются все системы "умного дома", чтобы работать с датчиками и устройствами Xiaomi.

Но есть и более кардинальный способ — отказ от шлюза Xiaomi и MiHome. Т.е. организация своей собственной Zigbee-сети и подключение датчиков и устройств Xiaomi к ней. Вот об этом чуть более подробно.

## Варианты решения

Один из вариантов — использовать иной хаб Zigbee-устройств. Например, Samsung SmartThings, Wink Hub 2, Mixtile Hub или какой-то иной. Но это "менять шило на мыло" и значительного профита никакого — данные как улетали, так и будут улетать, только в другие края.

Второй вариант — спец платы, добавляющие функционал Zigbee нашему серверу "Умного дома". Это уже более удобный вариант для нашего параноика.

Эти устройства выступают в роли "Координатора" Zigbee-сети (вместо шлюза Xiaomi) и организуют сеть, регистрируют устройства и могут управлять ими. Дополнительно, эти решения позволяют подключать все разнообразные Zigbee-устройства, а не только от Xiaomi.

В Европе есть несколько экземпляров таких устройств. 

### Dresden Elektronik 

[ConBee][2] или [RaspBee][3]

![][4]

Для работы требуют установки специального драйвера и приложения. А для возможности интеграции в систему "Умного дома", требуется [REST-плагин][5], обрабатывающий http-запросы:

Стоимость ~$35  

 

### Zigate

![][6]



Совмещает в себе Zigbee и Wifi — может работать как шлюз.

Стоимость ~49.00 € 

Есть готовые наработки по интеграции в системы "Умного дома":

А вот у российских пользователей есть надежда на другой вариант, правда не сразу готовый для потребления:

### Texas Instruments

![][7]

[cc2531][8] или платы на базе [cc2530][9]

Для работы в качестве координатора Zigbee-сети, необходимо прошить специальную прошивку. После этого возможна интеграция с системами "Умного дома":

Стоимость ~$10 

Основная логика находится не в прошивке, а в модуле интеграции с системой "Умного дома", который работает с устройством. Поэтому, на текущий момент, еще не все zigbee-устройства Xiaomi через такой шлюз поддерживаются в системах "Умного дома". Но это дело времени.

## Чуть подробнее

Этот последний вариант я решил попробовать на себе.

Началось всё с библиотеки [zigbee-shepherd для node.js][10] , именно там я обнаружил упоминания о подключении датчиков xiaomi через zigbee-стик cc2531. Там же есть и прошивка и [инструкция по прошивке][11].

Для прошивки, необходимо присоединить стик через DEBUG-разъем на плате. Это 10 пинов (2*5) с шагом 1.27 мм. Поэтому, можно приобрести отдельно [контакты для подключения к такому разъему][12], либо взять [такую плату с кабелем][13].

Существует как минимум 2 варианта прошить USB-стик cc2531:

1. используя специализированные устройства, типа CCDebugger
2. используя Arduino-совместимые микроконтроллеры

Приобрести CCDebugger можно [например тут][14], либо чуть [иной блок][15].

Нужно установить [прошивальщик][16] и скачать [прошивку][17]. [Процесс прошивки очень быстрый — несколько секунд][18]. Вот еще один [вариант описан][19].Можно попробовать прошить через Arduino, с использованием проекта **, но с небольшими доработками!!!** Один из пользователей описал, что смог прошить CC2531 используя CCLib и [описал свои замечания][20].

Этот способ я тоже попробовал — не понравилось. Процесс прошивки длился около 1.5 часа.

После прошивки можно попробовать пример из библиотеки, либо установить проект , работающий на указанной выше библиотеке и попытаться подключить устройства.

Именно так началась разработка [драйвера для ioBroker][21]. Не все zigbee-устройства xiaomi подключились сразу — где-то потребовалось доработать библиотеку, но т.к. ее автор пока забросил, то используется отдельный форк с изменениями.

В итоге, удалось подключить все доступные мне устройства и получить все их параметры.

![][22]Слева направо: cc2531, cc2530, cc2530+cc2591, cc2530+RFX2401.

Также можно попробовать устройства на базе cc2530 с внешними антеннами — они "бьют" дальше (~50м в пределах прямой видимости), но выглядят чуть хуже и подключаются через UART. Справа устройство с усилителем — оно "бьет" еще дальше, стоит дороже, но толку не больше — сами датчики Xiaomi не могут послать такой же сильный сигнал, поэтому устройство их не слышит на больших расстояниях.

## Итого

Для нерешительных параноиков, подготовил сравнительную таблицу плюсов и минусов

| ----- |
| **Шлюз Xiaomi** |  **cc253x (стик)** |  
| ❌ Нужен аккаунт Xiaomi для начальной настройки в MiHome |  ✅ Независимость от аккаунта Xiaomi, Китая, наличия интернета |  
|  ❌ Работает только с устройствами Xiaomi |  ✅ Возможность работы с другими Zigbee-устройствами (не только Xiaomi, уже проверено в IKEA TRÅDFRI bulb и FLOALT panel) |  
|  ❌ Ограниченный (~10м) радиус доступности устройств |  ✅ Варианты с внешней антенной могут «услышать» устройства на достаточно большом расстоянии (~50м) |  
|  ❌ Стоимость ~ $30 |  ✅ Стоимость ~ $10 |  
|  ✅ Отличный внешний вид |  ❌ Голое устройство, с корпусом стоят дороже |  
|  ✅ Свободная возможность размещения (там где есть розетка) и доступ по Wifi |  ❌ Вставляется в компьютер (или микрокомпьютер/одноплатник/малина) и зависит от его расположения |  
|  ✅ Благодаря MiHome может управлять устройствами как со смартфона, так и из сторонней системы «Умного дома» |  ❌ Требует спец драйвер (софт), чтобы управлять устройствами из системы «Умного дома». Управление с телефона — только через систему «Умного дома». |  
|  🌀 Сценарии работы устройств настраиваются в MiHome или в системе «Умного дома» |  🌀 Сценарии работы устройств настраиваются в системе «Умного дома» |  
|  ✅ Можно использовать встроенную лампу, радио и датчик освещенности. Агрегирует также wifi-устройства Xiaomi |  ❌ Нет функций, кроме Zigbee |  
|  ✅ Не требует специальной доработки и работает «из коробки» |  ❌ Требуется специальная прошивка, без нее не работает. Либо приобрести уже прошитый стик (в личку), но это увеличивает стоимость. | 

И если вы всё-таки решитесь избавиться от шлюза Xiaomi — [спрашивайте][23] поддержку описанных устройств у своего поставщика системы "Умного дома".


[1]: https://music.yandex.ru/album/5040966
[2]: https://www.dresden-elektronik.de/funktechnik/solutions/wireless-light-control/conbee/
[3]: https://www.dresden-elektronik.de/funktechnik/solutions/wireless-light-control/raspbee/?L=1
[4]: https://www.indahomekit.ru/wp-content/uploads/2018/04/zigbee_1-300x297.jpg
[5]: https://github.com/dresden-elektronik/deconz-rest-plugin
[6]: https://www.indahomekit.ru/wp-content/uploads/2018/04/zigbee_2-221x300.jpg
[7]: https://www.indahomekit.ru/wp-content/uploads/2018/04/zigbee_3-300x210.jpg
[8]: http://www.ti.com/tool/CC2531EMK
[9]: http://www.ti.com/product/cc2530
[10]: https://github.com/zigbeer/zigbee-shepherd
[11]: https://github.com/zigbeer/zigbee-shepherd/wiki/Tutorial#Hardware
[12]: https://ru.aliexpress.com/item/10pcs-2x5-P-10-pin-1-27mm-Pitch-Pin-Header-Female-dual-row-straight-through-hole/32723648836.html
[13]: https://ru.aliexpress.com/item/Downloader-Cable-Bluetooth-4-0-CC2540-zigbee-CC2531-Sniffer-USB-dongle-BTool-Programmer-Wire-Download-Programming/32767478130.html
[14]: https://ru.aliexpress.com/item/Wholesale-CC-DEBUGGER-Debugger-and-Programmer-for-RF-System-on-Chips-TI-ORIGINAL-2540-2541-2530/32418374637.html
[15]: https://ru.aliexpress.com/item/SmartRF04EB-CC1110-CC2530-ZigBee-Downloader-USB-ZigBee-MCU-M100/32672405324.html
[16]: https://github.com/kirovilya/files/blob/master/flash-programmer-1.12.8.zip
[17]: https://github.com/kirovilya/files/blob/master/CC2531ZNP-Pro-Secure_LinkKeyJoin.hex
[18]: https://www.youtube.com/watch?v=4L7s2lP5SUw
[19]: https://community.openhab.org/t/ikea-tradfri-binding-pairing-a-light-without-a-dimming-remote/33371/6
[20]: https://github.com/wavesoft/CCLib/issues/19
[21]: https://github.com/kirovilya/ioBroker.zigbee/wiki
[22]: https://www.indahomekit.ru/wp-content/uploads/2018/04/sticks_4.jpg
[23]: https://github.com/mozilla-iot/gateway/issues/707
